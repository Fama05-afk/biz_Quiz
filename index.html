<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz Fiqh S√©curis√© ‚Äî Style Kahoot</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, 'Segoe UI', sans-serif;
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .card {
      background: white;
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 900px;
      width: 100%;
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 24px;
      color: white;
    }
    .header h1 { font-size: 28px; font-weight: 800; margin-bottom: 4px; }
    .header p { opacity: 0.9; font-size: 14px; }
    .content { padding: 32px 24px; }
    .mode-section {
      background: linear-gradient(135deg, #f6f8fb 0%, #e9ecef 100%);
      padding: 24px;
      border-radius: 16px;
      margin-bottom: 20px;
      border: 3px solid #dee2e6;
    }
    .mode-section.teacher {
      border-color: #667eea;
      background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
    }
    .mode-section.student {
      border-color: #10b981;
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    }
    .mode-title {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      font-size: 20px;
      font-weight: 700;
    }
    .icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    .icon.teacher { background: #667eea; }
    .icon.student { background: #10b981; }
    input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #dee2e6;
      border-radius: 12px;
      font-size: 15px;
      margin-bottom: 12px;
      font-family: inherit;
    }
    input:focus { outline: none; border-color: #667eea; }
    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
    }
    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }
    .btn-success:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
    }
    .btn-secondary {
      background: #e9ecef;
      color: #495057;
    }
    .btn-secondary:hover:not(:disabled) { background: #dee2e6; }
    .btn-small { padding: 8px 16px; font-size: 14px; width: auto; }
    .error {
      background: #fee;
      border: 2px solid #fcc;
      color: #c33;
      padding: 12px;
      border-radius: 12px;
      text-align: center;
      margin-top: 12px;
      font-weight: 600;
    }
    .info {
      text-align: center;
      color: #6c757d;
      font-size: 13px;
      margin-top: 20px;
    }
    .info p { margin: 4px 0; }
    .quiz-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px 24px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }
    .quiz-info h2 { font-size: 24px; font-weight: 800; }
    .quiz-info p { opacity: 0.9; font-size: 14px; }
    .score-display { text-align: right; }
    .score-display .score { font-size: 32px; font-weight: 900; }
    .score-display .label { font-size: 12px; opacity: 0.8; }
    .progress-bar {
      height: 12px;
      background: #e9ecef;
      border-radius: 999px;
      overflow: hidden;
      margin: 20px 24px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s;
    }
    .question-card { padding: 32px 24px; }
    .question-text {
      font-size: 24px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 32px;
      color: #212529;
    }
    .answers-grid { display: grid; gap: 12px; margin-bottom: 20px; }
    .answer-btn {
      padding: 16px 20px;
      border: 3px solid #dee2e6;
      border-radius: 12px;
      background: white;
      font-size: 16px;
      font-weight: 600;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }
    .answer-btn:hover:not(:disabled) {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .answer-btn:disabled { cursor: not-allowed; }
    .answer-btn.correct {
      background: #d1fae5;
      border-color: #10b981;
      color: #065f46;
    }
    .answer-btn.wrong {
      background: #fee2e2;
      border-color: #ef4444;
      color: #991b1b;
    }
    .answer-btn.selected {
      background: #e0e7ff;
      border-color: #667eea;
    }
    .result-message {
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      font-weight: 700;
      font-size: 18px;
      margin-top: 20px;
    }
    .result-message.success { background: #d1fae5; color: #065f46; }
    .result-message.error { background: #fee2e2; color: #991b1b; }
    .controls {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      flex-wrap: wrap;
    }
    .controls .btn { flex: 1; min-width: 140px; }
    .toolbar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
      align-items: center;
    }
    .room-code {
      font-family: 'Courier New', monospace;
      font-size: 24px;
      font-weight: 900;
      letter-spacing: 2px;
    }
    .timer-badge {
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,0.2);
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .timer-badge span {
      font-weight: 700;
    }
    .lobby-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 20px;
      margin-top: 24px;
      align-items: flex-start;
    }
    .lobby-panel {
      background: #f8fafc;
      border-radius: 16px;
      padding: 16px;
      border: 1px solid #e2e8f0;
    }
    .lobby-panel h3 {
      font-size: 16px;
      margin-bottom: 8px;
      font-weight: 700;
    }
    .student-list {
      max-height: 180px;
      overflow-y: auto;
      margin-top: 8px;
    }
    .student-chip {
      background: #e0f2fe;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 13px;
      margin: 4px;
      display: inline-block;
    }
    .qr-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      text-align: center;
      font-size: 12px;
      color: #4b5563;
      word-break: break-all;
    }
    .qr-wrapper img {
      border-radius: 16px;
      border: 4px solid #e5e7eb;
      background: white;
    }
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal h3 {
      font-size: 24px;
      margin-bottom: 16px;
      text-align: center;
    }
    .leaderboard-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .leaderboard-item .name { font-weight: 700; font-size: 18px; }
    .leaderboard-item .score { font-weight: 900; font-size: 20px; color: #667eea; }
    @media (max-width: 700px) {
      .lobby-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 600px) {
      .quiz-header { text-align: center; }
      .score-display { text-align: center; }
      .question-text { font-size: 20px; }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="card" id="app"></div>
</div>

<div class="modal" id="leaderboardModal">
  <div class="modal-content">
    <h3>üèÜ Classement</h3>
    <div id="leaderboardContent"></div>
    <button class="btn btn-primary" onclick="closeLeaderboard()">Fermer</button>
  </div>
</div>

<script>
// ============================
// 1. QUESTIONS PAR D√âFAUT
// ============================
const DEFAULT_QUESTIONS = [
  {
    text: "Celui qui a oubli√© le qun√ªt dans la pri√®re du matin‚Ä¶",
    answers: ["Sajada ba'da as-sal√¢m", "Sajada qabla as-sal√¢m", "·π¢al√¢tuhu ·π£a·∏•√Æ·∏•a"],
    correct: 0
  },
  {
    text: "Quel est le jugement de celui qui a ajout√© dans la pri√®re quelque chose √©quivalent‚Ä¶",
    answers: ["·π¢a·∏•·∏•at ·π£al√¢tuhu", "Ba·π≠ulat ·π£al√¢tuhu", "Sajada ba'da as-sal√¢m", "Sajada qabla as-sal√¢m"],
    correct: 0
  },
  {
    text: "J'ai r√©cit√© √† voix haute dans la pri√®re de l' øA·π£r‚Ä¶",
    answers: ["Sajadtu qabla as-salƒÅm", "Sajadtu ba øda as-salƒÅm", "LƒÅ suj√ªda  øalayhi", "·π¢alƒÅtƒ´ ·π£a·∏•ƒ´·∏•a"],
    correct: 0
  },
  {
    text: "La prosternation de l'oubli dans la pri√®re a lieu lorsqu'on d√©laisse‚Ä¶",
    answers: ["ThalƒÅtha sunan", "Sunnah wƒÅ·∏•idah", "Sunnatayn", "Arba'a sunan"],
    correct: 0
  },
  {
    text: "J'√©tais en pri√®re et j'ai entendu la mention du Proph√®te Mu·∏•ammad (Ô∑∫)‚Ä¶",
    answers: ["Sajadtu ba øda as-salƒÅm", "Kuri·∏•at wa-lƒÅkin ·π£a·∏•·∏•at ·π£alƒÅtƒ´", "Ba·π≠ulat ·π£alƒÅtƒ´", "LƒÅ suj√ªda  øalayya"],
    correct: 0
  }
];

// ============================
// 2. STORAGE SIMPLIFI√â (m√©moire locale)
// ============================
const inMemoryStorage = {};

const StorageAPI = {
  async set(key, value) {
    return new Promise((resolve) => {
      setTimeout(() => {
        inMemoryStorage[key] = value;
        resolve({ key, value });
      }, 10);
    });
  },
  async get(key) {
    return new Promise((resolve, reject) => {
      setTimeout(() => {
        if (inMemoryStorage[key]) {
          resolve({ key, value: inMemoryStorage[key] });
        } else {
          reject(new Error('Key not found'));
        }
      }, 10);
    });
  }
};

// ============================
// 3. BACKEND SIMUL√â
// ============================
const SecureBackend = {
  async createRoom(teacherPin, questions) {
    const roomId = Math.random().toString(36).substr(2, 6).toUpperCase();
    const room = {
      id: roomId,
      teacherPin,
      questions,
      currentQuestion: null, // null = lobby
      students: {},
      status: 'lobby',       // 'lobby' | 'running' | 'finished'
      questionDuration: 20,
      createdAt: Date.now()
    };
    await StorageAPI.set(`room:${roomId}`, JSON.stringify(room));
    return { success: true, roomId };
  },

  async getRoom(roomId) {
    try {
      const result = await StorageAPI.get(`room:${roomId}`);
      return JSON.parse(result.value);
    } catch {
      return null;
    }
  },

  async joinRoom(roomId, studentName) {
    const room = await this.getRoom(roomId);
    if (!room) return { success: false, error: "Salle introuvable" };

    const studentId = Math.random().toString(36).substr(2, 9);
    room.students[studentId] = {
      name: studentName,
      score: 0,
      answers: {},
      joinedAt: Date.now()
    };

    await StorageAPI.set(`room:${roomId}`, JSON.stringify(room));
    return {
      success: true,
      studentId,
      currentQuestion: room.currentQuestion,
      status: room.status
    };
  },

  async submitAnswer(roomId, studentId, questionIndex, answerIndex, timeSpent) {
    const room = await this.getRoom(roomId);
    if (!room || !room.students[studentId]) {
      return { success: false, error: "Session invalide" };
    }
    const question = room.questions[questionIndex];
    if (!question) return { success: false, error: "Question invalide" };

    if (room.students[studentId].answers[questionIndex]) {
      return { success: false, error: "D√©j√† r√©pondu", alreadyAnswered: true };
    }

    const isCorrect = answerIndex === question.correct;
    let points = 0;
    if (isCorrect) {
      points = 1000;
      if (timeSpent < 3000) points += 500;
      else if (timeSpent < 5000) points += 300;
      else if (timeSpent < 10000) points += 100;
    }

    room.students[studentId].answers[questionIndex] = {
      answer: answerIndex,
      correct: isCorrect,
      points,
      timeSpent,
      timestamp: Date.now()
    };
    room.students[studentId].score += points;

    await StorageAPI.set(`room:${roomId}`, JSON.stringify(room));
    return {
      success: true,
      correct: isCorrect,
      correctAnswer: question.correct,
      points,
      totalScore: room.students[studentId].score
    };
  },

  async startOrGoToQuestion(roomId, teacherPin, questionIndex, durationSec) {
    const room = await this.getRoom(roomId);
    if (!room || room.teacherPin !== teacherPin) {
      return { success: false, error: "Non autoris√©" };
    }
    room.currentQuestion = questionIndex;
    room.status = 'running';
    room.questionDuration = durationSec;
    room.questionStartedAt = Date.now();
    await StorageAPI.set(`room:${roomId}`, JSON.stringify(room));
    return { success: true };
  },

  async getLeaderboard(roomId) {
    const room = await this.getRoom(roomId);
    if (!room) return [];
    return Object.entries(room.students)
      .map(([id, s]) => ({ id, name: s.name, score: s.score }))
      .sort((a, b) => b.score - a.score);
  }
};

// ============================
// 4. √âTAT GLOBAL
// ============================
const State = {
  mode: 'home',          // 'home' | 'teacher' | 'student' | 'studentWaiting'
  teacherMode: 'lobby',  // 'lobby' | 'quiz'
  roomId: '',
  teacherPin: '',
  studentName: '',
  studentId: '',
  currentQuestion: 0,
  questions: DEFAULT_QUESTIONS.slice(),
  hasAnswered: false,
  selectedAnswer: null,
  result: null,
  score: 0,
  startTime: Date.now(),
  error: '',
  loading: false,
  pollInterval: null,
  teacherPollInterval: null,
  roomSnapshot: null,
  questionDuration: 20,
  remainingTime: null,
  timerInterval: null
};

// ============================
// 5. RENDER PRINCIPAL
// ============================
function render() {
  const app = document.getElementById('app');
  if (State.mode === 'home') renderHome(app);
  else if (State.mode === 'teacher') renderTeacher(app);
  else if (State.mode === 'student') renderStudent(app);
  else if (State.mode === 'studentWaiting') renderStudentWaiting(app);
}

// ---------------- Home ----------------
function renderHome(container) {
  // lire √©ventuel ?room= dans l'URL pour pr√©-remplir
  const params = new URLSearchParams(window.location.search);
  const roomFromUrl = params.get('room');
  if (roomFromUrl && !State.roomId) {
    State.roomId = roomFromUrl.toUpperCase();
  }

  container.innerHTML = `
    <div class="header">
      <h1>Quiz Fiqh S√©curis√©</h1>
      <p>Mini-Kahoot sans backend ‚Äî version d√©mo</p>
    </div>
    <div class="content">
      <div class="mode-section teacher">
        <div class="mode-title">
          <div class="icon teacher">üë®‚Äçüè´</div>
          <span>Mode Enseignant</span>
        </div>
        <input type="password" id="teacherPin" placeholder="Cr√©e un PIN (min 4 caract√®res)" value="${State.teacherPin}">
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
          <label style="font-size:13px; color:#4b5563;">Dur√©e par question :</label>
          <select id="durationSelect" style="flex:1; padding:8px 10px; border-radius:10px; border:1px solid #d1d5db;">
            <option value="10" ${State.questionDuration===10?'selected':''}>10 s</option>
            <option value="20" ${State.questionDuration===20?'selected':''}>20 s</option>
            <option value="30" ${State.questionDuration===30?'selected':''}>30 s</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="createRoom()" ${State.loading ? 'disabled' : ''}>
          ${State.loading ? 'Cr√©ation...' : 'Cr√©er une salle'}
        </button>
      </div>
      
      <div class="mode-section student">
        <div class="mode-title">
          <div class="icon student">üë®‚Äçüéì</div>
          <span>Mode √âl√®ve</span>
        </div>
        <input type="text" id="roomCode" placeholder="Code de la salle (ex: ABC123)" value="${State.roomId}">
        <input type="text" id="studentName" placeholder="Ton pr√©nom" value="${State.studentName}">
        <button class="btn btn-success" onclick="joinRoom()" ${State.loading ? 'disabled' : ''}>
          ${State.loading ? 'Connexion...' : 'Rejoindre la salle'}
        </button>
      </div>
      
      ${State.error ? `<div class="error">${State.error}</div>` : ''}
      
      <div class="info">
        <p>üîí Version locale sans vrai serveur (d√©mo d√©veloppeur)</p>
        <p>‚è± Dur√©e par question g√©r√©e c√¥t√© enseignant</p>
        <p>üì± QR code g√©n√©r√© quand la salle est cr√©√©e</p>
      </div>
    </div>
  `;

  document.getElementById('teacherPin').addEventListener('input', e => {
    State.teacherPin = e.target.value;
  });
  document.getElementById('roomCode').addEventListener('input', e => {
    State.roomId = e.target.value.toUpperCase();
  });
  document.getElementById('studentName').addEventListener('input', e => {
    State.studentName = e.target.value;
  });
  document.getElementById('durationSelect').addEventListener('change', e => {
    State.questionDuration = parseInt(e.target.value, 10);
  });
}

// ---------------- Teacher ----------------
function renderTeacher(container) {
  const room = State.roomSnapshot;
  const q = State.questions[State.currentQuestion] || State.questions[0];
  const total = State.questions.length;
  const progress = ((State.currentQuestion + 1) / total) * 100;

  if (State.teacherMode === 'lobby') {
    const joinUrl = window.location.origin + window.location.pathname + '?room=' + State.roomId;
    const qrUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=' + encodeURIComponent(joinUrl);
    const students = room && room.students ? Object.values(room.students) : [];

    container.innerHTML = `
      <div class="header">
        <h1>Lobby ‚Äî Quiz Fiqh</h1>
        <p>Donne le code ou le QR aux √©l√®ves puis lance le quiz quand tout le monde est l√†.</p>
      </div>
      <div class="content">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
          <div>
            <p style="font-size:13px; color:#6b7280;">Code salle :</p>
            <div class="room-code">${State.roomId}</div>
          </div>
          <div class="timer-badge">
            ‚è± Dur√©e par question : <span>${State.questionDuration}s</span>
          </div>
        </div>

        <div class="lobby-grid">
          <div class="lobby-panel">
            <h3>√âl√®ves connect√©s (${students.length})</h3>
            <div class="student-list">
              ${
                students.length === 0
                  ? '<p style="font-size:13px; color:#9ca3af;">En attente des √©l√®ves‚Ä¶</p>'
                  : students.map(s => `<span class="student-chip">${s.name}</span>`).join('')
              }
            </div>
          </div>
          <div class="lobby-panel">
            <h3>QR code √† projeter</h3>
            <div class="qr-wrapper">
              <img src="${qrUrl}" alt="QR Code salle">
              <div>Ou lien direct :</div>
              <code style="font-size:11px;">${joinUrl}</code>
            </div>
          </div>
        </div>

        <div style="margin-top:24px; display:flex; gap:12px; flex-wrap:wrap;">
          <button class="btn btn-primary" onclick="startQuiz()" ${students.length === 0 ? 'disabled' : ''}>
            üöÄ Lancer le quiz
          </button>
          <button class="btn btn-secondary" onclick="backToHome()">Quitter</button>
        </div>

        <div class="info">
          <p>Les √©l√®ves qui rejoignent apr√®s le lancement arriveront automatiquement sur la question en cours.</p>
        </div>
      </div>
    `;
    return;
  }

  // Mode quiz enseignant
  container.innerHTML = `
    <div class="quiz-header">
      <div class="quiz-info">
        <h2>Mode Enseignant</h2>
        <p>Salle: <span class="room-code" style="font-size:18px;">${State.roomId}</span></p>
      </div>
      <div class="toolbar">
        <div class="timer-badge">
          ‚è≥ Temps restant : <span id="teacherTimer">${State.remainingTime !== null ? State.remainingTime : State.questionDuration}s</span>
        </div>
        <select id="durationSelectTeacher" style="padding:6px 10px; border-radius:999px; border:1px solid #d1d5db; font-size:12px;">
          <option value="10" ${State.questionDuration===10?'selected':''}>10 s</option>
          <option value="20" ${State.questionDuration===20?'selected':''}>20 s</option>
          <option value="30" ${State.questionDuration===30?'selected':''}>30 s</option>
        </select>
        <button class="btn btn-secondary btn-small" onclick="shuffleQuestions()">üîÄ M√©langer</button>
        <button class="btn btn-secondary btn-small" onclick="showLeaderboard()">üèÜ Classement</button>
        <button class="btn btn-secondary btn-small" onclick="backToHome()">Quitter</button>
      </div>
    </div>

    <div class="progress-bar">
      <div class="progress-fill" style="width:${progress}%"></div>
    </div>

    <div class="question-card">
      <p style="text-align:center;font-size:14px;font-weight:600;margin-bottom:8px;color:#6c757d;">
        Question ${State.currentQuestion + 1}/${total}
      </p>
      <p style="text-align:center;font-size:13px;margin-bottom:20px;color:#10b981;font-weight:600;">
        ‚úÖ Bonne r√©ponse: ${q.answers[q.correct]}
      </p>
      <div class="question-text">${q.text}</div>
      <div class="answers-grid">
        ${q.answers.map((answer, idx) => `
          <div class="answer-btn ${idx === q.correct ? 'correct' : ''}" style="cursor:default;">
            <strong>${idx + 1}.</strong> ${answer}
          </div>
        `).join('')}
      </div>
      <div class="controls">
        <button class="btn btn-secondary" onclick="prevQuestion()" ${State.currentQuestion === 0 ? 'disabled' : ''}>
          ‚Üê Pr√©c√©dent
        </button>
        <button class="btn btn-primary" onclick="nextQuestion()" ${State.currentQuestion === total - 1 ? 'disabled' : ''}>
          Suivant ‚Üí
        </button>
      </div>
    </div>
  `;

  const durationSelect = document.getElementById('durationSelectTeacher');
  if (durationSelect) {
    durationSelect.addEventListener('change', e => {
      State.questionDuration = parseInt(e.target.value, 10);
    });
  }
}

// -------------- Student waiting --------------
function renderStudentWaiting(container) {
  container.innerHTML = `
    <div class="header">
      <h1>En attente du lancement‚Ä¶</h1>
      <p>Salle: ${State.roomId}</p>
    </div>
    <div class="content" style="text-align:center;">
      <p style="font-size:16px;margin-bottom:12px;">Bonjour <strong>${State.studentName}</strong> üëã</p>
      <p style="font-size:14px;color:#6b7280;margin-bottom:20px;">
        L'enseignant n'a pas encore lanc√© le quiz. Reste sur cette page, il d√©marrera automatiquement.
      </p>
      <div style="font-size:30px;">‚è≥</div>
    </div>
  `;
}

// -------------- Student quiz --------------
function renderStudent(container) {
  const q = State.questions[State.currentQuestion];
  const total = State.questions.length;
  const progress = ((State.currentQuestion + 1) / total) * 100;

  container.innerHTML = `
    <div class="quiz-header">
      <div class="quiz-info">
        <h2>${State.studentName}</h2>
        <p>Salle: ${State.roomId}</p>
      </div>
      <div class="score-display">
        <div class="score">${State.score}</div>
        <div class="label">points</div>
      </div>
    </div>

    <div class="progress-bar">
      <div class="progress-fill" style="width:${progress}%"></div>
    </div>

    <div class="question-card">
      <p style="text-align:center;font-size:14px;font-weight:600;margin-bottom:20px;color:#6c757d;">
        Question ${State.currentQuestion + 1}/${total}
      </p>
      <div class="question-text">${q.text}</div>
      <div class="answers-grid">
        ${q.answers.map((answer, idx) => {
          let btnClass = 'answer-btn';
          if (State.hasAnswered && State.result) {
            if (idx === State.result.correctAnswer) btnClass += ' correct';
            if (idx === State.selectedAnswer && !State.result.correct) btnClass += ' wrong';
          } else if (idx === State.selectedAnswer) {
            btnClass += ' selected';
          }
          return `
            <button class="${btnClass}" onclick="submitAnswer(${idx})" ${State.hasAnswered ? 'disabled' : ''}>
              <strong>${idx + 1}.</strong> ${answer}
            </button>
          `;
        }).join('')}
      </div>
      ${State.result ? `
        <div class="result-message ${State.result.correct ? 'success' : 'error'}">
          ${State.result.correct ? `‚úÖ Bravo! +${State.result.points} points` : '‚ùå Mauvaise r√©ponse'}
        </div>
      ` : ''}
      ${State.error ? `<div class="error">${State.error}</div>` : ''}
    </div>
  `;
}

// ============================
// 6. ACTIONS ENSEIGNANT
// ============================
async function createRoom() {
  if (!State.teacherPin || State.teacherPin.length < 4) {
    State.error = "Le PIN doit contenir au moins 4 caract√®res";
    render();
    return;
  }
  State.loading = true;
  State.error = '';
  render();

  const result = await SecureBackend.createRoom(State.teacherPin, State.questions);
  if (result.success) {
    State.roomId = result.roomId;
    State.mode = 'teacher';
    State.teacherMode = 'lobby';
    State.currentQuestion = 0;
    State.remainingTime = null;
    await refreshTeacherRoom();
    startTeacherPolling();
  } else {
    State.error = result.error || "Erreur de cr√©ation";
  }
  State.loading = false;
  render();
}

async function startQuiz() {
  State.teacherMode = 'quiz';
  State.currentQuestion = 0;
  await SecureBackend.startOrGoToQuestion(State.roomId, State.teacherPin, 0, State.questionDuration);
  startQuestionTimer();
  render();
}

async function nextQuestion() {
  const total = State.questions.length;
  if (State.currentQuestion < total - 1) {
    State.currentQuestion += 1;
    await SecureBackend.startOrGoToQuestion(State.roomId, State.teacherPin, State.currentQuestion, State.questionDuration);
    startQuestionTimer();
    render();
  }
}

async function prevQuestion() {
  if (State.currentQuestion > 0) {
    State.currentQuestion -= 1;
    await SecureBackend.startOrGoToQuestion(State.roomId, State.teacherPin, State.currentQuestion, State.questionDuration);
    startQuestionTimer();
    render();
  }
}

function shuffleQuestions() {
  for (let i = State.questions.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [State.questions[i], State.questions[j]] = [State.questions[j], State.questions[i]];
  }
  State.currentQuestion = 0;
  if (State.mode === 'teacher' && State.teacherMode === 'quiz') {
    SecureBackend.startOrGoToQuestion(State.roomId, State.teacherPin, 0, State.questionDuration);
    startQuestionTimer();
  }
  render();
}

async function refreshTeacherRoom() {
  const room = await SecureBackend.getRoom(State.roomId);
  State.roomSnapshot = room;
}

function startTeacherPolling() {
  stopTeacherPolling();
  State.teacherPollInterval = setInterval(async () => {
    await refreshTeacherRoom();
    if (State.mode === 'teacher') render();
  }, 2000);
}

function stopTeacherPolling() {
  if (State.teacherPollInterval) {
    clearInterval(State.teacherPollInterval);
    State.teacherPollInterval = null;
  }
}

// Timer c√¥t√© enseignant
function startQuestionTimer() {
  stopQuestionTimer();
  State.remainingTime = State.questionDuration;
  State.timerInterval = setInterval(() => {
    if (State.remainingTime === null) return;
    State.remainingTime -= 1;
    const timerEl = document.getElementById('teacherTimer');
    if (timerEl) timerEl.textContent = State.remainingTime + 's';
    if (State.remainingTime <= 0) {
      stopQuestionTimer();
      autoAdvanceAfterTimer();
    }
  }, 1000);
}

function stopQuestionTimer() {
  if (State.timerInterval) {
    clearInterval(State.timerInterval);
    State.timerInterval = null;
  }
}

async function autoAdvanceAfterTimer() {
  const total = State.questions.length;
  if (State.currentQuestion < total - 1) {
    await nextQuestion();
  } else {
    // fin de quiz
    State.teacherMode = 'quiz';
    render();
  }
}

async function showLeaderboard() {
  const leaderboard = await SecureBackend.getLeaderboard(State.roomId);
  const modal = document.getElementById('leaderboardModal');
  const content = document.getElementById('leaderboardContent');
  content.innerHTML = leaderboard.map((s, idx) => `
    <div class="leaderboard-item">
      <span class="name">${idx + 1}. ${s.name}</span>
      <span class="score">${s.score}</span>
    </div>
  `).join('');
  modal.classList.add('active');
}

function closeLeaderboard() {
  document.getElementById('leaderboardModal').classList.remove('active');
}

function backToHome() {
  stopPolling();
  stopTeacherPolling();
  stopQuestionTimer();
  Object.assign(State, {
    mode: 'home',
    teacherMode: 'lobby',
    roomId: '',
    teacherPin: '',
    studentName: '',
    studentId: '',
    currentQuestion: 0,
    hasAnswered: false,
    selectedAnswer: null,
    result: null,
    score: 0,
    error: '',
    roomSnapshot: null,
    remainingTime: null
  });
  render();
}

// ============================
// 7. ACTIONS √âL√àVE
// ============================
async function joinRoom() {
  if (!State.roomId || !State.studentName) {
    State.error = "Remplis tous les champs";
    render();
    return;
  }
  State.loading = true;
  State.error = '';
  render();

  const result = await SecureBackend.joinRoom(State.roomId, State.studentName);
  if (result.success) {
    State.studentId = result.studentId;
    State.currentQuestion = result.currentQuestion ?? 0;
    if (result.status === 'running' && result.currentQuestion !== null) {
      State.mode = 'student';
      State.startTime = Date.now();
      startPolling();
    } else {
      State.mode = 'studentWaiting';
      startPolling();
    }
  } else {
    State.error = result.error || "Erreur de connexion";
  }
  State.loading = false;
  render();
}

async function submitAnswer(answerIndex) {
  if (State.hasAnswered) return;
  const timeSpent = Date.now() - State.startTime;
  State.selectedAnswer = answerIndex;
  State.hasAnswered = true;
  render();

  const result = await SecureBackend.submitAnswer(
    State.roomId,
    State.studentId,
    State.currentQuestion,
    answerIndex,
    timeSpent
  );
  if (result.success) {
    State.result = result;
    State.score = result.totalScore;
  } else if (result.alreadyAnswered) {
    State.error = "Tu as d√©j√† r√©pondu √† cette question";
  }
  render();
}

// polling √©l√®ve pour suivre la question en cours
function startPolling() {
  stopPolling();
  State.pollInterval = setInterval(async () => {
    const room = await SecureBackend.getRoom(State.roomId);
    if (!room) return;
    if (room.status === 'running' && State.mode === 'studentWaiting') {
      State.mode = 'student';
      State.currentQuestion = room.currentQuestion ?? 0;
      State.hasAnswered = false;
      State.selectedAnswer = null;
      State.result = null;
      State.startTime = Date.now();
      render();
      return;
    }
    if (room.currentQuestion !== null && room.currentQuestion !== State.currentQuestion) {
      State.currentQuestion = room.currentQuestion;
      State.hasAnswered = false;
      State.selectedAnswer = null;
      State.result = null;
      State.startTime = Date.now();
      if (State.mode === 'student') render();
    }
  }, 2000);
}

function stopPolling() {
  if (State.pollInterval) {
    clearInterval(State.pollInterval);
    State.pollInterval = null;
  }
}

// D√©marrage initial
render();
</script>

</body>
</html>
